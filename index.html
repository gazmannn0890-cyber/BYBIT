<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BVBIT | Крипто-обменник</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Стили остаются такими же как в предыдущей версии */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --dark-bg: #0f0f0f;
            --darker-bg: #0a0a0a;
            --card-bg: #1a1a1a;
            --card-border: #2a2a2a;
            --accent-orange: #ff6b00;
            --accent-orange-dark: #e55e00;
            --text-silver: #e0e0e0;
            --text-gray: #b0b0b0;
            --text-light: #ffffff;
            --success: #00d26a;
            --error: #ff4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-silver);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles */
        .header {
            background: var(--darker-bg);
            border-bottom: 1px solid var(--card-border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-light);
        }

        .logo-icon {
            color: var(--accent-orange);
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-gray);
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-link:hover {
            color: var(--accent-orange);
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--accent-orange);
            color: var(--text-light);
        }

        .btn-primary:hover {
            background: var(--accent-orange-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-gray);
            border: 1px solid var(--card-border);
        }

        .btn-secondary:hover {
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }

        /* Exchange Widget Styles */
        .exchange-section {
            padding: 4rem 0;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
        }

        .exchange-widget {
            max-width: 500px;
            margin: 0 auto;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .widget-title {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
            color: var(--text-light);
        }

        .widget-subtitle {
            text-align: center;
            color: var(--text-gray);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .currency-input {
            display: flex;
            border: 2px solid var(--card-border);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            background: var(--card-bg);
        }

        .currency-input:focus-within {
            border-color: var(--accent-orange);
        }

        .input-field {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .input-field:focus {
            outline: none;
        }

        .currency-selector {
            background: rgba(255, 107, 0, 0.1);
            border-left: 1px solid var(--card-border);
            display: flex;
            align-items: center;
        }

        .currency-dropdown {
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-weight: 600;
            cursor: pointer;
            min-width: 120px;
        }

        .swap-container {
            display: flex;
            justify-content: center;
            margin: 1rem 0;
        }

        .swap-btn {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-gray);
            transition: all 0.3s ease;
        }

        .swap-btn:hover {
            background: var(--accent-orange);
            color: var(--text-light);
            border-color: var(--accent-orange);
            transform: rotate(180deg);
        }

        .exchange-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            color: var(--text-gray);
        }

        .info-row.total {
            font-weight: 700;
            color: var(--text-light);
            border-top: 1px solid var(--card-border);
            padding-top: 0.75rem;
            margin-top: 0.75rem;
        }

        .exchange-btn {
            width: 100%;
            padding: 1.25rem;
            background: var(--accent-orange);
            color: var(--text-light);
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .exchange-btn:hover:not(:disabled) {
            background: var(--accent-orange-dark);
            transform: translateY(-2px);
        }

        .exchange-btn:disabled {
            background: var(--text-gray);
            cursor: not-allowed;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .status-online {
            color: var(--success);
        }

        .status-offline {
            color: var(--error);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            z-index: 10000;
            animation: slideInRight 0.3s ease;
        }

        .notification.success {
            background: var(--success);
            color: white;
        }

        .notification.error {
            background: var(--error);
            color: white;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="nav">
                <div class="logo">
                    <span class="logo-icon">₿</span>
                    <span class="logo-text">BVBIT</span>
                </div>
                <nav class="nav-links">
                    <a href="#" class="nav-link active">Обмен</a>
                    <a href="#" class="nav-link">Тарифы</a>
                    <a href="#" class="nav-link">Поддержка</a>
                </nav>
                <div class="nav-actions">
                    <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                        Панель трейдера
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Exchange Section -->
    <section class="exchange-section">
        <div class="container">
            <div class="exchange-widget">
                <h1 class="widget-title">Обмен криптовалют</h1>
                <p class="widget-subtitle">Реальные курсы от Bybit</p>
                
                <div class="exchange-form">
                    <!-- From Currency -->
                    <div class="form-group">
                        <label class="form-label">Отдаете</label>
                        <div class="currency-input">
                            <input type="number" class="input-field" id="from-amount" placeholder="0.0" value="100">
                            <div class="currency-selector">
                                <select class="currency-dropdown" id="from-currency">
                                    <option value="USDT">USDT</option>
                                    <option value="BTC">BTC</option>
                                    <option value="ETH">ETH</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Swap Button -->
                    <div class="swap-container">
                        <button class="swap-btn" id="swap-currencies">
                            ⇅
                        </button>
                    </div>

                    <!-- To Currency -->
                    <div class="form-group">
                        <label class="form-label">Получаете</label>
                        <div class="currency-input">
                            <input type="number" class="input-field" id="to-amount" placeholder="0.0" readonly>
                            <div class="currency-selector">
                                <select class="currency-dropdown" id="to-currency">
                                    <option value="BTC">BTC</option>
                                    <option value="ETH" selected>ETH</option>
                                    <option value="USDT">USDT</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Exchange Info -->
                    <div class="exchange-info">
                        <div class="info-row">
                            <span>Курс Bybit:</span>
                            <span id="exchange-rate">Загрузка...</span>
                        </div>
                        <div class="info-row">
                            <span>Комиссия:</span>
                            <span id="fee-amount">0.5%</span>
                        </div>
                        <div class="info-row total">
                            <span>Итого к получению:</span>
                            <span id="total-amount">0.0</span>
                        </div>
                    </div>

                    <!-- API Status -->
                    <div class="api-status" id="api-status">
                        <i class="fas fa-circle"></i>
                        <span>Подключение к Bybit...</span>
                    </div>

                    <!-- Exchange Button -->
                    <button class="exchange-btn" id="exchange-button" disabled>
                        Обменять
                    </button>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Bybit API configuration
        const BYBIT_CONFIG = {
            baseURL: 'https://api.bybit.com',
            endpoints: {
                tickers: '/v5/market/tickers',
                order: '/v5/order/create'
            },
            commission: 0.005, // 0.5%
            supportedPairs: [
                'BTCUSDT', 'ETHUSDT', 'BTCUSD', 'ETHUSD',
                'USDTUSD', 'USDUSDT'
            ]
        };

        // DOM Elements
        const elements = {
            fromAmount: document.getElementById('from-amount'),
            toAmount: document.getElementById('to-amount'),
            fromCurrency: document.getElementById('from-currency'),
            toCurrency: document.getElementById('to-currency'),
            swapBtn: document.getElementById('swap-currencies'),
            exchangeRate: document.getElementById('exchange-rate'),
            feeAmount: document.getElementById('fee-amount'),
            totalAmount: document.getElementById('total-amount'),
            exchangeButton: document.getElementById('exchange-button'),
            apiStatus: document.getElementById('api-status')
        };

        // State
        let currentRates = {};
        let isAPIOnline = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            connectToBybit();
            startPriceUpdates();
        });

        // Event Listeners
        function initEventListeners() {
            elements.fromAmount.addEventListener('input', calculateExchange);
            elements.fromCurrency.addEventListener('change', handleCurrencyChange);
            elements.toCurrency.addEventListener('change', handleCurrencyChange);
            elements.swapBtn.addEventListener('click', swapCurrencies);
            elements.exchangeButton.addEventListener('click', executeExchange);
        }

        // Bybit API Integration
        async function connectToBybit() {
            try {
                updateAPIStatus('Подключение к Bybit...', 'loading');
                
                // Test connection by fetching tickers
                const tickers = await fetchBybitTickers();
                
                if (tickers && tickers.result) {
                    currentRates = processTickerData(tickers.result.list);
                    updateAPIStatus('Bybit подключен', 'online');
                    isAPIOnline = true;
                    calculateExchange();
                } else {
                    throw new Error('Invalid response from Bybit');
                }
            } catch (error) {
                console.error('Bybit connection failed:', error);
                updateAPIStatus('Ошибка подключения', 'offline');
                isAPIOnline = false;
                // Fallback to mock data
                loadMockData();
            }
        }

        async function fetchBybitTickers() {
            try {
                const symbol = 'BTCUSDT,ETHUSDT,BTCUSD,ETHUSD';
                const response = await fetch(
                    `${BYBIT_CONFIG.baseURL}${BYBIT_CONFIG.endpoints.tickers}?category=spot&symbol=${symbol}`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error fetching from Bybit:', error);
                return null;
            }
        }

        function processTickerData(tickers) {
            const rates = {};
            
            tickers.forEach(ticker => {
                const symbol = ticker.symbol;
                const price = parseFloat(ticker.lastPrice);
                
                if (symbol.includes('USDT')) {
                    const base = symbol.replace('USDT', '');
                    rates[`${base}-USDT`] = price;
                    rates[`USDT-${base}`] = 1 / price;
                } else if (symbol.includes('USD')) {
                    const base = symbol.replace('USD', '');
                    rates[`${base}-USD`] = price;
                    rates[`USD-${base}`] = 1 / price;
                }
            });

            // Add cross rates
            if (rates['BTC-USDT'] && rates['ETH-USDT']) {
                rates['BTC-ETH'] = rates['BTC-USDT'] / rates['ETH-USDT'];
                rates['ETH-BTC'] = rates['ETH-USDT'] / rates['BTC-USDT'];
            }

            return rates;
        }

        // Price updates every 5 seconds
        function startPriceUpdates() {
            setInterval(async () => {
                if (isAPIOnline) {
                    const tickers = await fetchBybitTickers();
                    if (tickers && tickers.result) {
                        currentRates = processTickerData(tickers.result.list);
                        calculateExchange();
                    }
                }
            }, 5000);
        }

        // Exchange calculation
        function calculateExchange() {
            if (!isAPIOnline) return;

            const from = elements.fromCurrency.value;
            const to = elements.toCurrency.value;
            const amount = parseFloat(elements.fromAmount.value) || 0;

            if (amount <= 0) {
                elements.toAmount.value = '';
                elements.exchangeRate.textContent = 'Введите сумму';
                elements.totalAmount.textContent = '0.0';
                elements.exchangeButton.disabled = true;
                return;
            }

            const rate = getExchangeRate(from, to);
            
            if (!rate) {
                elements.exchangeRate.textContent = 'Курс недоступен';
                elements.exchangeButton.disabled = true;
                return;
            }

            const fee = amount * BYBIT_CONFIG.commission;
            const amountAfterFee = amount - fee;
            const receivedAmount = amountAfterFee * rate;

            elements.toAmount.value = receivedAmount.toFixed(8);
            elements.exchangeRate.textContent = `1 ${from} = ${rate.toFixed(6)} ${to}`;
            elements.feeAmount.textContent = `${(BYBIT_CONFIG.commission * 100).toFixed(1)}%`;
            elements.totalAmount.textContent = `${receivedAmount.toFixed(6)} ${to}`;
            elements.exchangeButton.disabled = false;
        }

        function getExchangeRate(from, to) {
            if (from === to) return 1;

            const directPair = `${from}-${to}`;
            const reversePair = `${to}-${from}`;

            if (currentRates[directPair]) {
                return currentRates[directPair];
            }

            if (currentRates[reversePair]) {
                return 1 / currentRates[reversePair];
            }

            // Cross rates via USDT
            if (from !== 'USDT' && to !== 'USDT') {
                const fromToUSDT = currentRates[`${from}-USDT`];
                const usdtToTarget = currentRates[`USDT-${to}`];
                
                if (fromToUSDT && usdtToTarget) {
                    return fromToUSDT * usdtToTarget;
                }
            }

            return null;
        }

        // UI Functions
        function handleCurrencyChange() {
            calculateExchange();
        }

        function swapCurrencies() {
            const tempFrom = elements.fromCurrency.value;
            const tempTo = elements.toCurrency.value;
            
            elements.fromCurrency.value = tempTo;
            elements.toCurrency.value = tempFrom;
            
            const tempAmount = elements.fromAmount.value;
            elements.fromAmount.value = elements.toAmount.value;
            elements.toAmount.value = tempAmount;
            
            calculateExchange();
        }

        function updateAPIStatus(message, status) {
            const statusIcon = elements.apiStatus.querySelector('i');
            const statusText = elements.apiStatus.querySelector('span');
            
            statusText.textContent = message;
            
            statusIcon.className = 'fas fa-circle';
            elements.apiStatus.className = 'api-status';
            
            switch (status) {
                case 'online':
                    statusIcon.style.color = 'var(--success)';
                    elements.apiStatus.classList.add('status-online');
                    break;
                case 'offline':
                    statusIcon.style.color = 'var(--error)';
                    elements.apiStatus.classList.add('status-offline');
                    break;
                case 'loading':
                    statusIcon.className = 'fas fa-sync-alt fa-spin';
                    statusIcon.style.color = 'var(--warning)';
                    break;
            }
        }

        // Exchange execution
        async function executeExchange() {
            if (!isAPIOnline) {
                showNotification('Ошибка: Нет подключения к бирже', 'error');
                return;
            }

            const from = elements.fromCurrency.value;
            const to = elements.toCurrency.value;
            const amount = parseFloat(elements.fromAmount.value);
            const received = parseFloat(elements.toAmount.value);

            // Show loading state
            elements.exchangeButton.disabled = true;
            elements.exchangeButton.textContent = 'Обработка...';
            elements.exchangeButton.classList.add('loading');

            try {
                // In real implementation, this would create an order on Bybit
                // For demo, we'll simulate the exchange
                await simulateExchange(from, to, amount, received);
                
                showNotification(`Обмен выполнен! ${amount} ${from} → ${received} ${to}`, 'success');
                
                // Reset form
                setTimeout(() => {
                    elements.fromAmount.value = '';
                    elements.toAmount.value = '';
                    elements.exchangeButton.textContent = 'Обменять';
                    elements.exchangeButton.classList.remove('loading');
                    calculateExchange();
                }, 2000);

            } catch (error) {
                showNotification('Ошибка при выполнении обмена', 'error');
                elements.exchangeButton.disabled = false;
                elements.exchangeButton.textContent = 'Обменять';
                elements.exchangeButton.classList.remove('loading');
            }
        }

        // Mock data for fallback
        function loadMockData() {
            currentRates = {
                'BTC-USDT': 45000,
                'USDT-BTC': 1/45000,
                'ETH-USDT': 2500,
                'USDT-ETH': 1/2500,
                'BTC-ETH': 18,
                'ETH-BTC': 1/18,
                'USD-USDT': 1,
                'USDT-USD': 1
            };
            updateAPIStatus('Демо-режим (мок данные)', 'offline');
            calculateExchange();
        }

        function simulateExchange(from, to, amount, received) {
            return new Promise((resolve) => {
                setTimeout(resolve, 2000);
            });
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
    </script>
</body>
</html>
